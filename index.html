<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T∆∞ v·∫•n tr·ª±c tuy·∫øn</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    #chat-box::-webkit-scrollbar, #history-box::-webkit-scrollbar { width: 6px; }
    #chat-box::-webkit-scrollbar-thumb, #history-box::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    #chat-box::-webkit-scrollbar-thumb:hover, #history-box::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="flex bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-7xl h-[800px]">

    <!-- Sidebar tr√°i -->
    <div class="w-1/4 bg-gray-100 p-6 flex flex-col border-r border-gray-200">
      <h1 class="text-3xl font-bold text-blue-600 mb-6">MEDIVERSE</h1>
      <h2 class="text-xl font-semibold text-gray-800 mb-4">T∆∞ v·∫•n tr·ª±c tuy·∫øn</h2>

      <!-- Menu -->
      <ul id="main-menu" class="space-y-3 font-medium text-lg">
        <li id="menu-doctor" class="p-3 rounded-xl hover:bg-gray-200 cursor-pointer flex items-center justify-between text-gray-700">
          <div class="flex items-center space-x-3"><i class="fas fa-user-md"></i><span>B√°c sƒ©</span></div>
          <i class="fas fa-chevron-right" id="arrow-doctor"></i>
        </li>
        <li id="menu-ai" class="p-3 rounded-xl hover:bg-gray-200 cursor-pointer flex items-center justify-between text-gray-700">
          <div class="flex items-center space-x-3"><i class="fas fa-robot"></i><span>Chatbot AI</span></div>
        </li>
        <li id="menu-history" class="p-3 rounded-xl hover:bg-gray-200 cursor-pointer flex items-center justify-between text-gray-700">
          <div class="flex items-center space-x-3"><i class="fas fa-history"></i><span>L·ªãch s·ª≠</span></div>
          <i class="fas fa-chevron-right" id="arrow-history"></i>
        </li>
      </ul>

      <!-- History list -->
      <div id="history-box" class="mt-4 flex-1 overflow-y-auto hidden"></div>
    </div>

    <!-- Chat box -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <div class="p-6 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fas fa-comments text-2xl text-blue-600"></i>
          <h2 id="chat-title" class="text-lg font-bold text-gray-800">Ch·ªçn m·ª•c b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu</h2>
        </div>
      </div>

      <!-- Chat messages -->
      <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

      <!-- Input -->
      <div class="p-6 border-t border-gray-200 flex items-center space-x-3 bg-white">
        <input id="message-input" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..." class="flex-1 p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="send-btn" class="p-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>

    <!-- Sidebar ph·∫£i -->
    <div class="w-1/4 bg-gray-50 p-6 flex flex-col border-l border-gray-200">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Th√¥ng tin</h2>
      <div id="info-box" class="bg-white p-4 rounded-xl shadow-sm text-gray-600 mb-6">
        <p>Ch·ªçn t√≠nh nƒÉng t·ª´ menu b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
      </div>

      <h3 class="text-lg font-semibold text-gray-800 mb-3">FAQ</h3>
      <div class="faq-item bg-gray-200 p-2 rounded-xl cursor-pointer mb-2 hover:bg-gray-300">T√¥i n√™n u·ªëng thu·ªëc th·∫ø n√†o?</div>
      <div class="faq-item bg-gray-200 p-2 rounded-xl cursor-pointer mb-2 hover:bg-gray-300">Tri·ªáu ch·ª©ng n√†y c√≥ ƒë√°ng lo?</div>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:3000";
    const userId = "user001";
    let activeConversationId = null;
    let activeMode = null; // "ai" | "doctor"

    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const chatTitle = document.getElementById("chat-title");
    const infoBox = document.getElementById("info-box");
    const historyBox = document.getElementById("history-box");
    const arrowDoctor = document.getElementById("arrow-doctor");
    const arrowHistory = document.getElementById("arrow-history");

    function addMessage(role, content) {
      const wrap = document.createElement("div");
      wrap.className = "flex w-full";
      const div = document.createElement("div");
      if (role === "user") {
        wrap.classList.add("justify-end");
        div.className = "bg-blue-600 text-white rounded-xl p-3 max-w-sm shadow";
        div.textContent = content;
      } else {
        wrap.classList.add("justify-start");
        div.className = "bg-gray-200 text-gray-800 rounded-xl p-3 max-w-sm shadow";
        div.innerHTML = marked.parse(content);
      }
      wrap.appendChild(div);
      chatBox.appendChild(wrap);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function setActiveMenu(id) {
      document.querySelectorAll("#main-menu li").forEach(li => li.classList.remove("bg-blue-100", "text-blue-700"));
      const active = document.getElementById(id);
      if (active) active.classList.add("bg-blue-100", "text-blue-700");
    }

    async function startNewConversation(mode) {
      const res = await fetch(`${API_URL}/conversation`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId })
      });
      const data = await res.json();
      activeConversationId = data.id;
      activeMode = mode;
    }

    // Chat AI
    document.getElementById("menu-ai").addEventListener("click", async () => {
      setActiveMenu("menu-ai");
      chatBox.innerHTML = "";
      chatTitle.textContent = "Chatbot AI";
      infoBox.innerHTML = "<p>Chat v·ªõi AI ü§ñ ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.</p>";
      await startNewConversation("ai");
      addMessage("assistant", "Xin ch√†o, t√¥i l√† Chatbot AI ü§ñ. B·∫°n c·∫ßn g√¨?");
    });

    // Chat b√°c sƒ© (l·∫•y 3 g·∫ßn nh·∫•t + suggested)
    document.getElementById("menu-doctor").addEventListener("click", async () => {
      toggleSection("doctor");
      setActiveMenu("menu-doctor");
      chatBox.innerHTML = "";
      chatTitle.textContent = "Chat v·ªõi b√°c sƒ©";
      infoBox.innerHTML = "<p>ƒêang t·∫£i d·ªØ li·ªáu b√°c sƒ©...</p>";

      const res = await fetch(`${API_URL}/doctor-info?userId=${userId}`);
      const data = await res.json();
      if (!data.success) {
        infoBox.innerHTML = "<p class='text-red-600'>Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu b√°c sƒ©.</p>";
        return;
      }
      let html = "<h3 class='font-bold mb-2'>3 b√°c sƒ© g·∫ßn nh·∫•t:</h3>";
      data.recent.forEach(doc => {
        html += `<div class='p-2 bg-gray-200 mb-2 rounded cursor-pointer hover:bg-gray-300' onclick="loadDoctor('${doc.id}')">üë®‚Äç‚öïÔ∏è ${doc.name} (${doc.specialty})</div>`;
      });
      if (data.suggested) {
        html += `<h3 class='font-bold mt-4 mb-2'>B√°c sƒ© g·ª£i √Ω:</h3><div class='p-2 bg-blue-100 mb-2 rounded cursor-pointer hover:bg-blue-200' onclick="startDoctor('${data.suggested.name}', '${data.suggested.specialty}')">‚≠ê ${data.suggested.name} (${data.suggested.specialty})</div>`;
      }
      infoBox.innerHTML = html;
    });

    window.loadDoctor = async function(id) {
      activeConversationId = id;
      chatBox.innerHTML = "";
      const res = await fetch(`${API_URL}/conversation/${id}`);
      const detail = await res.json();
      detail.messages.forEach(m => addMessage(m.role, m.content));
      addDeleteButton(id);
    };

    window.startDoctor = async function(name, specialty) {
      await startNewConversation("doctor");
      infoBox.innerHTML = `<p><b>B√°c sƒ©:</b> ${name}<br><b>Khoa:</b> ${specialty}</p>`;
      addMessage("assistant", `Xin ch√†o, t√¥i l√† <b>${name}</b>, b√°c sƒ© chuy√™n khoa <b>${specialty}</b>. T√¥i c√≥ th·ªÉ h·ªó tr·ª£ g√¨ cho b·∫°n?`);
      addDeleteButton(activeConversationId);
    };

    // L·ªãch s·ª≠
    document.getElementById("menu-history").addEventListener("click", async () => {
      toggleSection("history");
      setActiveMenu("menu-history");
      historyBox.classList.remove("hidden");
      historyBox.innerHTML = "<p>ƒêang t·∫£i l·ªãch s·ª≠...</p>";
      const res = await fetch(`${API_URL}/conversations/${userId}`);
      const data = await res.json();
      if (!data.success) return historyBox.innerHTML = "<p>L·ªói t·∫£i l·ªãch s·ª≠</p>";
      historyBox.innerHTML = data.conversations.map(c => `
        <div class='p-2 mb-2 bg-gray-200 rounded flex justify-between items-center'>
          <span class='cursor-pointer hover:underline' onclick="loadDoctor('${c.id}')">üó®Ô∏è ${c.preview}</span>
          <button class='text-red-500 hover:text-red-700' onclick="deleteConversation('${c.id}')"><i class='fas fa-trash'></i></button>
        </div>`).join("");
    });

    async function sendMessage() {
      const msg = input.value.trim();
      if (!msg || !activeConversationId) return;
      addMessage("user", msg);
      input.value = "";
      const res = await fetch(`${API_URL}/chat/${activeConversationId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, question: msg })
      });
      const data = await res.json();
      if (data.success) addMessage("assistant", data.answer);
      else addMessage("assistant", "‚ùå L·ªói khi g·ª≠i tin.");
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

    document.querySelectorAll(".faq-item").forEach(item => item.addEventListener("click", () => {
      input.value = item.innerText;
      sendMessage();
    }));

    // Toggle sections Doctor/History
    function toggleSection(section) {
      if (section === "doctor") {
        const open = arrowDoctor.classList.contains("fa-chevron-down");
        arrowDoctor.className = open ? "fas fa-chevron-right" : "fas fa-chevron-down";
        arrowHistory.className = "fas fa-chevron-right";
        historyBox.classList.add("hidden");
      } else if (section === "history") {
        const open = arrowHistory.classList.contains("fa-chevron-down");
        arrowHistory.className = open ? "fas fa-chevron-right" : "fas fa-chevron-down";
        arrowDoctor.className = "fas fa-chevron-right";
        if (open) historyBox.classList.add("hidden");
      }
    }

    // X√≥a h·ªôi tho·∫°i
    window.deleteConversation = async function(id) {
      const confirmDel = confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a cu·ªôc tr√≤ chuy·ªán n√†y?");
      if (!confirmDel) return;
      const res = await fetch(`${API_URL}/conversation/${id}`, { method: "DELETE" });
      const data = await res.json();
      if (data.success) {
        alert("ƒê√£ x√≥a cu·ªôc tr√≤ chuy·ªán");
        document.getElementById("menu-history").click();
      } else {
        alert("‚ùå L·ªói khi x√≥a");
      }
    }

    // Th√™m n√∫t x√≥a v√†o khi m·ªü chat c·ª• th·ªÉ
    function addDeleteButton(id) {
      chatTitle.innerHTML += ` <button onclick="deleteConversation('${id}')" class='ml-2 text-red-500 hover:text-red-700'><i class='fas fa-trash'></i></button>`;
    }

    // Khi m·ªõi m·ªü trang -> t·ª± ƒë·ªông v√†o Chat AI
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("menu-ai").click();
    });
  </script>
</body>
</html>
